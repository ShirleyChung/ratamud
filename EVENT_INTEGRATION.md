# 事件系統整合完成

## ✅ 已完成的整合工作

### 1. GameWorld 整合
在 `src/world.rs` 中：
- 添加 `event_manager: EventManager` 欄位
- 添加 `event_scheduler: EventScheduler` 欄位
- 在 `GameWorld::new()` 中初始化事件系統

### 2. 主循環整合
在 `src/app.rs` 中：
- 每秒檢查並觸發事件
- 顯示事件觸發訊息，包含位置描述
- 執行事件動作
- 新增 `check_and_execute_events()` 函數
- 新增 `get_event_location_info()` 函數獲取位置描述
- 新增 `check_event_trigger()` 和 `check_event_conditions()` 函數

### 3. 事件載入
在 `src/main.rs` 中：
- 啟動時自動載入 `worlds/初始世界/events/` 目錄下的所有事件
- 顯示載入的事件數量

### 4. 事件輸出格式
事件觸發時會顯示：
```
🎭 事件: 商人到訪 在 初始之地(50, 50) - 空曠的廣場
```
包含：
- 事件名稱
- 地圖名稱
- 座標
- 該座標的地點描述

## 📁 已創建的事件腳本

### 1. merchant_visit.json（商人到訪）
- **觸發**：每 5 分鐘，白天時段（9:00-18:00）
- **位置**：初始之地 (50, 50)
- **效果**：商人出現，顯示對話

### 2. treasure_spawn.json（神秘寶藏）
- **觸發**：每 3 分鐘，30% 機率
- **位置**：初始之地 (30, 30)
- **效果**：生成神秘寶箱，顯示提示訊息
- **冷卻**：3 分鐘

### 3. hourly_bell.json（整點鐘聲）
- **觸發**：每小時整點
- **位置**：初始之地
- **效果**：顯示鐘聲訊息

### 4. discover_shrine.json（發現神殿）
- **觸發**：進入位置 (25, 25)
- **位置**：初始之地 (25, 25)
- **效果**：顯示發現訊息
- **限制**：只觸發一次

### 5. morning_event.json（清晨問候）
- **觸發**：每天 9:00
- **位置**：初始之地
- **效果**：顯示早晨問候

## 🎮 測試方式

1. **啟動遊戲**
   ```bash
   cargo run --release
   ```

2. **觀察事件**
   - 等待幾分鐘，觀察商人到訪事件（每5分鐘）
   - 觀察整點鐘聲事件（每小時）
   - 觀察隨機寶藏事件（每3分鐘，30%機率）

3. **移動到特殊位置**
   - 使用方向鍵移動
   - 移動到 (25, 25) 觸發發現神殿事件
   - 移動到 (30, 30) 可能發現寶箱
   - 移動到 (50, 50) 看商人

4. **查看時間**
   - 觀察狀態列的時間顯示
   - 等待 9:00 看早晨問候事件

## 📊 事件觸發機制

### 時間檢查
```
每秒（1現實秒 = 60遊戲秒）
└─> 檢查是否進入新的分鐘
    └─> 遍歷所有事件
        ├─> 檢查運行時狀態（冷卻、次數）
        ├─> 檢查觸發器（Crontab 表達式）
        ├─> 檢查條件（地圖、位置、物品）
        └─> 執行事件動作
```

### 輸出格式
```
🎭 事件: [事件名稱] 在 [地圖名](x, y) - [地點描述]
📢 [事件訊息]
👤 [NPC動作]
🎁 [物品動作]
```

## 🔧 添加新事件

### 1. 創建 JSON 文件
在 `worlds/初始世界/events/` 對應目錄下創建 `.json` 文件

### 2. 事件模板
```json
{
  "id": "unique_event_id",
  "name": "事件名稱",
  "description": "事件描述",
  "trigger": {
    "type": "time",
    "schedule": "*/10 * * * *"
  },
  "where": {
    "map": "初始之地",
    "positions": [[x, y]]
  },
  "actions": [
    {
      "type": "message",
      "text": "事件訊息"
    }
  ],
  "state": {
    "repeatable": true,
    "cooldown": 0,
    "max_triggers": -1,
    "prerequisites": []
  }
}
```

### 3. 重新啟動遊戲
事件會自動載入

## 🎯 事件類型範例

### 定時事件
```json
"trigger": {
  "type": "time",
  "schedule": "0 12 * * *"  // 每天中午12點
}
```

### 隨機事件
```json
"trigger": {
  "type": "time",
  "schedule": "*/5 * * * *",
  "random_chance": 0.5  // 50%機率
}
```

### 時段限制
```json
"trigger": {
  "type": "time",
  "schedule": "0 * * * *",
  "time_range": ["09:00:00", "18:00:00"]  // 白天
}
```

### 位置限制
```json
"where": {
  "map": "初始之地",
  "positions": [[10, 20], [10, 21]]  // 多個位置
}
```

### 區域限制
```json
"where": {
  "map": "初始之地",
  "area": {
    "x": [10, 20],
    "y": [10, 20]
  }
}
```

### 物品需求
```json
"what": {
  "required_items": ["古老的鑰匙", "神秘地圖"]
}
```

## 🚀 未來擴展

### 已準備但未實現
- [ ] 位置觸發事件（需要在移動時調用檢查）
- [ ] NPC 真實生成和移除（目前只有訊息）
- [ ] 事件狀態持久化保存
- [ ] 更多動作類型（天氣、音效等）

### 可以立即擴展
- ✅ 添加更多事件腳本
- ✅ 調整觸發頻率
- ✅ 設計事件鏈
- ✅ 創建每日/每週事件

## 📝 注意事項

1. **時間流速**：1 現實秒 = 60 遊戲秒
2. **分鐘檢查**：事件每遊戲分鐘檢查一次（約 1 現實秒）
3. **冷卻時間**：以遊戲秒為單位
4. **座標系統**：0-based，左上角為 (0, 0)
5. **事件 ID**：必須唯一

## 🎊 系統已就緒

事件系統已完全整合到遊戲中，可以開始創造豐富的遊戲內容！
只需編寫 JSON 腳本，無需修改代碼即可添加新事件。
