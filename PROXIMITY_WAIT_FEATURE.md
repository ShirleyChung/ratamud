# 距離檢測與 Wait 指令功能說明

## 概述
本次更新實現了以下功能：
1. **統一角色管理**：將 `me` 也納入 `npc_manager` 管理
2. **距離檢測系統**：自動檢測 NPC 靠近/離開玩家
3. **見面對話**：NPC 走到玩家身邊時會說見面語
4. **Wait 指令**：根據好感度叫住 NPC

---

## 1. 統一角色管理

### 變更內容
- `me` 不再單獨處理，而是存儲在 `npc_manager` 中
- ID 固定為 `"me"`
- 與其他 NPC 一樣從 `persons/me.json` 載入
- 簡化了 `main.rs` 的程式碼

### 優點
- 程式碼更簡潔
- 邏輯更統一
- 方便未來擴展（如多玩家支持）

---

## 2. 距離檢測系統

### 功能說明
系統會自動追蹤 NPC 與當前操控角色的距離變化：

- **靠近通知**（距離從 1 → 0）
  - 顯示：`xxx 往這邊走來`
  - 觸發條件：NPC 從相鄰格走到同一格
  
- **離開通知**（距離從 0 → 1）
  - 顯示：`xxx 離開了`
  - 觸發條件：NPC 從同一格走到相鄰格

### 技術細節
- 使用曼哈頓距離計算
- 追蹤每個 NPC 的前一次距離
- 考慮 `ctrl` 指令切換操控的情況
- 使用 `{current_controlled_id}_{npc_id}` 作為 key

---

## 3. 見面對話

### 功能說明
當 NPC 走到玩家身邊（距離變為 0）時：
1. 顯示靠近通知
2. NPC 自動說出「見面」話題的對話

### 設定見面語
使用 `sdl` 指令設定：
```
sdl 商人 見面 哈囉！你好，來看看我的商品
sdl 櫻花 見面 嗨～又見面了！
```

支持條件式對話：
```
sdl 櫻花 set 見面 when 顏值>80 say 哇！你今天看起來真帥！
sdl 商人 見面 add 歡迎光臨！ when 好感度>50
```

---

## 4. Wait 指令

### 指令語法
```
wait <npc名稱>
```

### 功能說明
- **目的**：叫住 NPC，讓其停止走動
- **距離限制**：NPC 必須在相鄰格或同一格（距離 ≤ 1）
- **成功率**：根據好感度計算
  - 公式：`50% + 好感度/2`
  - 好感度 -100：成功率 0%
  - 好感度 0：成功率 50%
  - 好感度 100：成功率 100%

### 成功效果
1. NPC 停止 AI 行為（`is_interacting = true`）
2. 顯示：`你叫住了 xxx`
3. NPC 說出「被叫住」的話

### 失敗效果
- 顯示：`xxx 沒有理會你`
- NPC 繼續原本的行為

### 預設回應
所有 NPC 都有預設的「被叫住」對話：
```
{NPC名稱} 有什麼事嗎？
```

### 自訂回應
使用 `sdl` 指令：
```
sdl 商人 被叫住 什麼事？我很忙的！
sdl 櫻花 被叫住 怎麼了嗎？需要我幫忙嗎？
```

---

## 使用範例

### 範例 1：基本互動
```
> right         # 向右移動
商人 往這邊走來
商人 說：「哈囉！你好，來看看我的商品」

> wait 商人     # 叫住商人
你叫住了 商人
商人 說：「商人 有什麼事嗎？」

> talk 商人 閒聊
💬 跟商人開始閒聊...
商人 說：「最近生意不錯啊！」
```

### 範例 2：好感度影響
```
> setrel 櫻花 -50    # 設置低好感度
> wait 櫻花
櫻花 沒有理會你      # 成功率只有 25%，可能失敗

> addrel 櫻花 80      # 提升好感度到 30
> wait 櫻花
你叫住了 櫻花         # 成功率 65%，較容易成功
櫻花 說：「櫻花 有什麼事嗎？」
```

### 範例 3：設定個性化對話
```
> sdl 櫻花 見面 嗨～好久不見！
> sdl 櫻花 被叫住 怎麼啦？是想我了嗎？

# NPC 走過來時
櫻花 往這邊走來
櫻花 說：「嗨～好久不見！」

# 叫住時
> wait 櫻花
你叫住了 櫻花
櫻花 說：「怎麼啦？是想我了嗎？」
```

---

## 技術實現

### 核心文件修改
1. **npc_manager.rs**
   - 新增 `previous_distances: HashMap<String, usize>`
   - 新增 `update_proximity()` 方法
   - 修改 `load_all_from_directory()` 不跳過 "me"

2. **main.rs**
   - 簡化 me 初始化邏輯
   - 統一通過 npc_manager 載入所有角色

3. **person.rs**
   - 在 `Person::new()` 中設定預設「被叫住」對話

4. **input.rs**
   - 新增 `CommandResult::Wait(String)`
   - 新增 wait 指令解析

5. **app.rs**
   - 在主循環中呼叫 `update_proximity()`
   - 新增 `handle_wait()` 處理函數
   - 處理見面對話觸發

---

## 注意事項

1. **ctrl 指令兼容性**
   - 切換操控角色後，距離檢測會正確計算
   - 使用 `{當前角色ID}_{NPC_ID}` 作為距離記錄的 key

2. **性能考慮**
   - 只檢測同地圖的 NPC
   - 使用曼哈頓距離（快速計算）

3. **AI 互動**
   - `wait` 成功後設置 `is_interacting = true`
   - NPC AI 會檢查此標誌，暫停自動行為

---

## 未來擴展建議

1. **多級距離檢測**
   - 可增加 2→1（接近）、3→2（遠處可見）等
   
2. **告別對話**
   - NPC 離開時可說「告別」話題的對話

3. **Wait 時間限制**
   - 可設定 wait 後 NPC 停留的時間

4. **組合互動**
   - wait + trade：叫住後直接交易
   - wait + give：叫住後給予物品
