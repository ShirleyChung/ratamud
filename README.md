# RataTUI MUD 遊戲引擎

一個用 Rust 和 Ratatui 構建的文字冒險遊戲引擎，採用 MUD (Multi-User Dungeon) 風格的設計。

## 🎮 遊戲概述

這是一個終端式的互動冒險遊戲，玩家可以在虛擬世界中探索、移動、與 NPC 互動。遊戲特色包括：

- **多地圖世界系統**: 支援多個地圖，每個地圖包含 100×100 的點陣
- **動態 NPC 系統**: 5 種 NPC 類型（商人、路人、醫生、工人、農夫）隨機散布在地圖上
- **角色管理**: 玩家角色（Me）和所有 NPC 都可持久化存儲
- **觀察系統**: Observable trait 允許不同物件以統一方式展示信息
- **懸浮 UI 窗口**: 右側懸浮狀態窗口顯示角色信息

## 📁 項目結構

```
rataui_demo/
├── src/
│   ├── main.rs           # 主程序入口
│   ├── ui.rs             # UI 渲染邏輯
│   ├── input.rs          # 指令輸入處理
│   ├── output.rs         # 輸出管理
│   ├── map.rs            # 地圖系統
│   ├── world.rs          # 世界系統
│   ├── person.rs         # 角色系統
│   ├── observable.rs     # Observable trait
│   └── bin/
│       └── genmap.rs     # 地圖生成工具
├── worlds/               # 世界數據存儲
│   └── 初始世界/
│       ├── world.json    # 世界配置
│       ├── maps/         # 地圖文件
│       └── persons/      # 角色數據
├── Cargo.toml            # 項目配置
└── README.md             # 本文件
```

## 🎯 核心功能模組

### 1. 世界系統 (world.rs)
- 存儲世界的名稱、描述和所有地圖列表
- 管理世界狀態的持久化
- 支援多世界切換（預留功能）

### 2. 地圖系統 (map.rs)
- 100×100 的點陣式地圖結構
- 每個點 (Point) 包含：
  - `x, y` 坐標
  - `walkable`: 可移動/不可移動標記
  - `description`: 點的描述文本
  - `objects`: 該點上的物件（角色、物品等）

### 3. 角色系統 (person.rs)
- **Person 結構體**包含：
  - `id`: 唯一標識
  - `name`: 角色名稱
  - `description`: 角色描述
  - `abilities`: 能力信息
  - `items`: 持有物品
  - `status`: 當前狀態
  - `position`: 在地圖上的位置
- 支援序列化/反序列化持久化存儲

### 4. Observable 系統 (observable.rs)
- 統一的觀察介面 trait
- 方法：
  - `show_title()`: 標題
  - `show_description()`: 詳細描述
  - `show_list()`: 列表信息
- 實現類型：
  - `Person`: 顯示角色信息
  - `Empty`: 空狀態（默認）

### 5. UI 系統 (ui.rs)
- 基於 Ratatui 的終端 UI
- 三個主要區域：
  - **輸出區**: 顯示遊戲輸出和 look 命令結果
  - **輸入區**: 命令輸入框
  - **狀態欄**: 一行消息提示（5秒自動清除）
  - **懸浮窗**: 右側可選的角色狀態面板

## 🎮 遊戲指令

### 基本指令

| 指令 | 說明 | 例子 |
|------|------|------|
| `look` | 查看當前位置描述 | `look` |
| `l` / `r` / `u` / `d` | 向左/右/上/下移動 | `l` |
| `status` | 打開右側角色狀態窗口 | `status` |
| `hello <text>` | 顯示問候信息 | `hello world` |
| `help` | 顯示幫助信息 | `help` |

### 指令行為

- **正確指令**: 結果顯示在輸出區
- **錯誤指令**: 錯誤消息顯示在狀態欄，5秒後自動清除
- **移動指令**: 顯示"往 ? 移動"在狀態欄
- **status 指令**: 打開懸浮窗顯示 Me 的詳細信息
- **其他指令**: 關閉懸浮窗（如果打開）

## 🗂️ 數據存儲

### 世界配置 (worlds/初始世界/world.json)
```json
{
  "name": "初始世界",
  "description": "...",
  "maps": ["初始之地", "森林", "洞穴", "沙漠", "山脈"]
}
```

### 地圖文件 (worlds/初始世界/maps/*.json)
- 每個地圖存儲 100×100 的點陣信息
- 包含可移動性、描述和物件列表

### 角色數據 (worlds/初始世界/persons/*.json)
- 存儲所有角色（Me + NPC）的詳細信息
- 包括位置、能力、物品、狀態等

## 🛠️ 工具程序

### genmap 工具
生成初始地圖文件的獨立工具：

```bash
cargo run --bin genmap
```

功能：
- 生成 5 張地圖（初始之地、森林、洞穴、沙漠、山脈）
- 隨機分配可移動/不可移動的點
- 為每個點生成描述
- 保存為 JSON 文件

## 🚀 使用方法

### 1. 編譯項目
```bash
cargo build --release
```

### 2. 運行遊戲
```bash
cargo run
```

首次運行時：
- 自動檢查世界數據目錄
- 如果不存在則創建初始世界
- 生成所有必要的文件和 NPC

### 3. 遊戲流程
```
1. 遊戲啟動 → 載入初始世界和所有地圖
2. 載入所有 NPC 和玩家角色（Me）
3. 玩家在"初始之地"開始冒險
4. 輸入命令進行交互
5. 遊戲自動保存狀態
```

## 🎨 UI 設計

### 佈局示意
```
┌─────────────────────────────────┬──────────────────┐
│                                 │   角色狀態       │
│           輸出區                │  （懸浮窗）      │
│      (look 和命令結果)          │                  │
│                                 │  ┌────────────┐ │
│                                 │  │ 名字: Me   │ │
│                                 │  │ 描述: ...  │ │
│                                 │  │ 能力: ...  │ │
└─────────────────────────────────┴──────────────────┘
┌─────────────────────────────────────────────────────┐
│ > _                                                  │
│  (輸入框)                                            │
├─────────────────────────────────────────────────────┤
│ 狀態: 往右移動                                       │
│ (自動清除，5秒後)                                   │
└─────────────────────────────────────────────────────┘
```

## 🎭 NPC 系統

遊戲包含 5 種 NPC 類型，在初始之地隨機散布：

| NPC 類型 | 描述 | 數量 |
|---------|------|------|
| 商人 | 販賣物品的商業人士 | 1 |
| 路人 | 普通的行人 | 1 |
| 醫生 | 提供治療服務 | 1 |
| 工人 | 從事勞動工作 | 1 |
| 農夫 | 從事農業工作 | 1 |

所有 NPC 都會：
- 隨機放置在可移動的點上
- 被持久化存儲
- 在程序啟動時自動載入
- 可通過 status 窗口查看信息

## 🔧 技術棧

- **語言**: Rust
- **TUI 框架**: Ratatui
- **序列化**: Serde + serde_json
- **數據持久化**: JSON 文件
- **隨機數**: rand crate

## 📝 注意事項

1. **首次運行**: 會自動創建必要的目錄結構和文件
2. **數據保存**: 所有更改自動保存到 JSON 文件
3. **NPC 生成**: 每次啟動時重新載入已保存的 NPC
4. **地圖尺寸**: 當前固定為 100×100（可通過參數調整）

## 🚧 未來功能計劃

- [ ] NPC 對話系統
- [ ] 物品拾取和丟棄
- [ ] 戰鬥系統
- [ ] 任務系統
- [ ] 時間流逝系統
- [ ] 天氣系統
- [ ] 多世界支援
- [ ] 聯網多人模式（遠期）

## 📖 代碼文檔

詳細的實現記錄請見 [UPDATE.md](UPDATE.md)

## 👤 作者

RataTUI MUD 遊戲引擎

---

**最後更新**: 2025-12-06  
**版本**: 2.2.0
