# äº‹ä»¶ç³»çµ±å¯¦ç¾ç¸½çµ

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒæ¶æ§‹ï¼ˆ4å€‹æ–°æ¨¡çµ„ï¼‰

#### **src/event.rs** - äº‹ä»¶æ•¸æ“šçµæ§‹
- `TriggerType` - 5ç¨®è§¸ç™¼å™¨é¡å‹ï¼ˆtime, random, location, condition, manualï¼‰
- `WhoCondition` - äººç‰©æ¢ä»¶ï¼ˆç©å®¶ã€NPCã€ç­‰ç´šï¼‰
- `WhereCondition` - åœ°é»æ¢ä»¶ï¼ˆåœ°åœ–ã€åº§æ¨™ã€å€åŸŸï¼‰
- `WhatCondition` - ç‰©å“æ¢ä»¶ï¼ˆæŒæœ‰ç‰©å“ã€åœ°åœ–ç‰©å“ï¼‰
- `EventAction` - 7ç¨®å‹•ä½œé¡å‹
- `EventState` - äº‹ä»¶ç‹€æ…‹ç®¡ç†ï¼ˆå¯é‡è¤‡ã€å†·å»ã€è§¸ç™¼æ¬¡æ•¸ï¼‰
- `GameEvent` - å®Œæ•´äº‹ä»¶çµæ§‹
- `EventManager` - äº‹ä»¶ç®¡ç†å™¨
- `EventRuntimeState` - é‹è¡Œæ™‚ç‹€æ…‹è¿½è¹¤

#### **src/event_scheduler.rs** - äº‹ä»¶èª¿åº¦å™¨
- `CronParser` - Crontab è¡¨é”å¼è§£æå™¨
  - æ”¯æŒ `*`ï¼ˆä»»æ„ï¼‰
  - æ”¯æŒ `*/N`ï¼ˆæ¯Nå–®ä½ï¼‰
  - æ”¯æŒ `N-M`ï¼ˆç¯„åœï¼‰
  - æ”¯æŒå…·é«”å€¼
- `EventScheduler` - äº‹ä»¶èª¿åº¦é‚è¼¯
  - æ™‚é–“æª¢æŸ¥ï¼ˆæ¯åˆ†é˜ï¼‰
  - éš¨æ©Ÿè§¸ç™¼
  - æ¢ä»¶æª¢æŸ¥ï¼ˆäººäº‹æ™‚åœ°ç‰©ï¼‰
  - ä½ç½®è§¸ç™¼æª¢æŸ¥

#### **src/event_executor.rs** - äº‹ä»¶åŸ·è¡Œå™¨
- åŸ·è¡Œ7ç¨®å‹•ä½œï¼š
  1. spawn_npc - ç”Ÿæˆ NPC
  2. remove_npc - ç§»é™¤ NPC
  3. message - é¡¯ç¤ºè¨Šæ¯
  4. dialogue - NPCå°è©±
  5. add_item - æ·»åŠ åœ°åœ–ç‰©å“
  6. remove_item - ç§»é™¤åœ°åœ–ç‰©å“
  7. teleport - å‚³é€ç©å®¶

#### **src/event_loader.rs** - äº‹ä»¶åŠ è¼‰å™¨
- éè¿´è¼‰å…¥ç›®éŒ„ä¸­çš„æ‰€æœ‰äº‹ä»¶è…³æœ¬
- JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
- ç¯„ä¾‹äº‹ä»¶ç”Ÿæˆå™¨

### 2. æ–‡æª”

- âœ… `EVENT_SYSTEM_DESIGN.md` - è©³ç´°è¨­è¨ˆæ–‡æª”
- âœ… `EVENT_USAGE.md` - ä½¿ç”¨æŒ‡å—å’Œç¯„ä¾‹
- âœ… `EVENT_SYSTEM_SUMMARY.md` - æœ¬æ–‡ä»¶

### 3. ç¯„ä¾‹è…³æœ¬

å·²å‰µå»ºç¤ºç¯„äº‹ä»¶ï¼š
- `worlds/åˆå§‹ä¸–ç•Œ/events/time_based/merchant_visit.json`

## ğŸ¯ è¨­è¨ˆç‰¹é»

### 1. åŸºæ–¼ã€Œäººäº‹æ™‚åœ°ç‰©ã€åŸå‰‡
```
äºº (Who)   - ç©å®¶ã€NPCã€ç­‰ç´šæ¢ä»¶
äº‹ (What)  - äº‹ä»¶å‹•ä½œå’Œç‰©å“æ¢ä»¶
æ™‚ (When)  - æ™‚é–“è§¸ç™¼å™¨ï¼ˆCrontabï¼‰
åœ° (Where) - åœ°åœ–ã€åº§æ¨™ã€å€åŸŸ
ç‰© (What)  - ç‰©å“éœ€æ±‚å’Œæ“ä½œ
```

### 2. é¡ä¼¼ Crontab çš„æ™‚é–“è¡¨é”å¼
```
*/5 * * * *     - æ¯5åˆ†é˜
0 9-17 * * *    - 9:00-17:00 æ¯å°æ™‚
30 12 * * *     - æ¯å¤© 12:30
```

### 3. éˆæ´»çš„è§¸ç™¼æ©Ÿåˆ¶
- æ™‚é–“è§¸ç™¼ + éš¨æ©Ÿæ©Ÿç‡
- æ™‚é–“ç¯„åœé™åˆ¶
- å¤©æ•¸ç¯„åœé™åˆ¶
- ä½ç½®è§¸ç™¼
- æ¢ä»¶è§¸ç™¼

### 4. å®Œæ•´çš„äº‹ä»¶ç‹€æ…‹ç®¡ç†
- å¯é‡è¤‡/ä¸€æ¬¡æ€§
- å†·å»æ™‚é–“
- æœ€å¤§è§¸ç™¼æ¬¡æ•¸
- å‰ç½®æ¢ä»¶æª¢æŸ¥

## ğŸ“ ä½¿ç”¨ç¯„ä¾‹

### ç°¡å–®çš„å®šæ™‚äº‹ä»¶
```json
{
  "id": "merchant_visit",
  "name": "å•†äººåˆ°è¨ª",
  "trigger": {
    "type": "time",
    "schedule": "*/5 * * * *"
  },
  "actions": [
    {"type": "message", "text": "å•†äººä¾†äº†ï¼"}
  ]
}
```

### å¸¶éš¨æ©Ÿæ€§çš„äº‹ä»¶
```json
{
  "trigger": {
    "type": "time",
    "schedule": "*/10 * * * *",
    "random_chance": 0.3
  }
}
```

### è¤‡é›œæ¢ä»¶äº‹ä»¶
```json
{
  "where": {
    "map": "åˆå§‹ä¹‹åœ°",
    "area": {"x": [10, 20], "y": [10, 20]}
  },
  "what": {
    "required_items": ["å¤è€çš„é‘°åŒ™"]
  },
  "trigger": {
    "type": "time",
    "schedule": "0 * * * *",
    "time_range": ["09:00:00", "18:00:00"]
  }
}
```

## ğŸ”§ ä¸‹ä¸€æ­¥æ•´åˆï¼ˆå¾…å¯¦ç¾ï¼‰

1. **æ•´åˆåˆ° GameWorld**
   ```rust
   pub struct GameWorld {
       // ... ç¾æœ‰æ¬„ä½
       pub event_manager: EventManager,
       pub event_scheduler: EventScheduler,
   }
   ```

2. **æ•´åˆåˆ°éŠæˆ²ä¸»å¾ªç’°**
   ```rust
   // åœ¨ app.rs çš„ä¸»å¾ªç’°ä¸­
   let triggered = event_scheduler.check_and_trigger(
       &mut event_manager,
       game_world,
       player
   );
   
   for event_id in triggered {
       if let Some(event) = event_manager.get_event(&event_id) {
           EventExecutor::execute_event(event, game_world, player, output_manager);
       }
   }
   ```

3. **è¼‰å…¥äº‹ä»¶**
   ```rust
   // åœ¨ main.rs åˆå§‹åŒ–æ™‚
   let events_dir = format!("{}/events", game_world.world_dir);
   let count = EventLoader::load_from_directory(&mut event_manager, &events_dir)?;
   ```

4. **ç§»å‹•æ™‚æª¢æŸ¥ä½ç½®è§¸ç™¼**
   ```rust
   // åœ¨ç§»å‹•é‚è¼¯ä¸­
   let location_events = event_scheduler.check_location_trigger(
       &event_manager,
       player.x,
       player.y
   );
   ```

## ğŸš€ æœªä¾†æ“´å±•æ–¹å‘

### çŸ­æœŸ
- [ ] æ•´åˆåˆ°éŠæˆ²ä¸»å¾ªç’°
- [ ] äº‹ä»¶ç‹€æ…‹æŒä¹…åŒ–ï¼ˆä¿å­˜/è¼‰å…¥ï¼‰
- [ ] æ›´å¤šæ¸¬è©¦å’Œç¯„ä¾‹äº‹ä»¶

### ä¸­æœŸ
- [ ] NPC ç³»çµ±å®Œæ•´å¯¦ç¾
- [ ] å°è©±ç³»çµ±
- [ ] ä»»å‹™ç³»çµ±æ•´åˆ
- [ ] æ¢ä»¶è¡¨é”å¼è§£æå™¨

### é•·æœŸ
- [ ] è…³æœ¬èªè¨€æ”¯æŒï¼ˆLua/Rhaiï¼‰
- [ ] å¯è¦–åŒ–äº‹ä»¶ç·¨è¼¯å™¨
- [ ] äº‹ä»¶éˆå’Œè¤‡é›œä¾è³´
- [ ] å‹•æ…‹å¤©æ°£ç³»çµ±
- [ ] AI è¡Œç‚ºæ¨¹æ•´åˆ

## ğŸ“Š ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Game World                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     EventManager                â”‚   â”‚
â”‚  â”‚  - events: HashMap              â”‚   â”‚
â”‚  â”‚  - runtime_states: HashMap      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     EventScheduler              â”‚   â”‚
â”‚  â”‚  - check_and_trigger()          â”‚   â”‚
â”‚  â”‚  - check_location_trigger()     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Event JSON Files     â”‚
        â”‚  - time_based/        â”‚
        â”‚  - random/            â”‚
        â”‚  - location/          â”‚
        â”‚  - conditional/       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  EventExecutor        â”‚
        â”‚  - execute_event()    â”‚
        â”‚  - execute_action()   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¡ æŠ€è¡“äº®é»

1. **å®Œå…¨è…³æœ¬åŒ–** - ç„¡éœ€é‡æ–°ç·¨è­¯å³å¯æ·»åŠ æ–°äº‹ä»¶
2. **é¡å‹å®‰å…¨** - ä½¿ç”¨ Rust çš„å¼·é¡å‹ç³»çµ±
3. **åºåˆ—åŒ–æ”¯æŒ** - JSON æ ¼å¼æ˜“æ–¼ç·¨è¼¯
4. **éˆæ´»çš„è§¸ç™¼æ©Ÿåˆ¶** - å¤šç¨®è§¸ç™¼æ¢ä»¶çµ„åˆ
5. **ç‹€æ…‹ç®¡ç†** - å®Œæ•´çš„é‹è¡Œæ™‚ç‹€æ…‹è¿½è¹¤
6. **æ¨¡çµ„åŒ–è¨­è¨ˆ** - å„æ¨¡çµ„è·è²¬æ¸…æ™°

## ğŸ“ˆ ä»£ç¢¼çµ±è¨ˆ

- æ–°å¢æ¨¡çµ„ï¼š4 å€‹
- ä»£ç¢¼è¡Œæ•¸ï¼šç´„ 600 è¡Œ
- æ–‡æª”ï¼š3 ä»½
- ç¯„ä¾‹è…³æœ¬ï¼š1 å€‹ï¼ˆå¯å¿«é€Ÿæ“´å±•ï¼‰

äº‹ä»¶ç³»çµ±å·²æº–å‚™å°±ç·’ï¼Œå¯ä»¥é–‹å§‹å‰µå»ºè±å¯Œçš„éŠæˆ²å…§å®¹ï¼ğŸ®
