# RataMUD C/C++ ÁØÑ‰æãÊßãÂª∫ËÖ≥Êú¨

import os
import subprocess

Import('env')

# ÂâµÂª∫Êú¨Âú∞Áí∞Â¢É
local_env = env.Clone()

# Á¢∫‰øù dist ÁõÆÈåÑÂ≠òÂú®
dist_dir = local_env['DIST_DIR']
if not os.path.exists(dist_dir):
    os.makedirs(dist_dir)

# Ë®≠ÂÆöÁ∑®Ë≠ØÈÅ∏È†ÖÔºàdylib ÁâàÊú¨Ôºâ
local_env.Append(CPPPATH=['#/dist'])
local_env.Append(LIBPATH=['#/' + dist_dir])
local_env.Append(LIBS=['ratamud'])

if local_env['RPATH']:
    local_env.Append(LINKFLAGS=[local_env['RPATH']])

# Framework Áí∞Â¢ÉÔºàmacOSÔºâ
framework_env = None
if env.get('LIB_EXT') == 'dylib':
    framework_env = env.Clone()
    framework_dir = '#/frameworks'
    framework_env.Append(CPPPATH=[framework_dir + '/RataMUD.framework/Headers'])
    framework_env.Append(FRAMEWORKS=['RataMUD', 'CoreFoundation'])
    framework_env.Append(FRAMEWORKPATH=[framework_dir])
    framework_env.Append(LINKFLAGS=[f'-Wl,-rpath,{Dir(framework_dir).abspath}'])

# ===== Rust ÂáΩÂºèÂ∫´ =====
lib_name = f"libratamud.{local_env['LIB_EXT']}"
lib_target = File('#/' + os.path.join(dist_dir, lib_name))

rust_sources = Glob('#/src/*.rs') + Glob('#/src/**/*.rs')
cargo_toml = File('#/Cargo.toml')

def build_rust_lib(target, source, env):
    cwd = Dir('#').abspath
    build_type = env['BUILD_MODE']
    cmd = [env['CARGO'], 'build', '--lib']
    
    if build_type == 'release':
        cmd.append('--release')
    
    print(f"\n{env['COLORS']['cyan']}[CARGO] Building Rust library ({build_type})...{env['COLORS']['end']}")
    
    result = subprocess.run(cmd, cwd=cwd, capture_output=True, text=True)
    
    if result.returncode != 0:
        print(f"{env['COLORS']['red']}Cargo build failed:{env['COLORS']['end']}")
        print(result.stderr)
        return result.returncode
    
    # Ë§áË£ΩÂà∞ dist
    import shutil
    src_lib = os.path.join(cwd, env['RUST_TARGET_DIR'], lib_name)
    
    if not os.path.exists(src_lib):
        print(f"{env['COLORS']['red']}Error: Library not found at {src_lib}{env['COLORS']['end']}")
        return 1
    
    shutil.copy2(src_lib, str(target[0]))
    print(f"{env['COLORS']['green']}‚úì Rust library: {target[0]}{env['COLORS']['end']}\n")
    return None

rust_lib = local_env.Command(
    lib_target,
    rust_sources + [cargo_toml],
    build_rust_lib
)

local_env.Alias('lib', rust_lib)

# ===== macOS Framework =====
if env.get('LIB_EXT') == 'dylib':
    def build_framework(target, source, env):
        cwd = Dir('#').abspath
        framework_dir = os.path.join(cwd, 'frameworks', 'RataMUD.framework')
        
        # Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®
        if os.path.exists(os.path.join(framework_dir, 'RataMUD')):
            print(f"{env['COLORS']['green']}‚úì Framework already exists, skipping build{env['COLORS']['end']}\n")
            return None
        
        # ÊâãÂãïÂª∫Á´ã macOS Framework (‰∏çÂåÖÂê´ iOS)
        print(f"\n{env['COLORS']['cyan']}[FRAMEWORK] Building macOS Framework...{env['COLORS']['end']}")
        
        # 1. Á∑®Ë≠Ø Rust ÈùúÊÖãÂ∫´
        import platform
        arch = platform.machine()
        if arch == 'arm64':
            target_triple = 'aarch64-apple-darwin'
        else:
            target_triple = 'x86_64-apple-darwin'
        
        cmd = [env['CARGO'], 'build', '--release', '--target', target_triple, '--lib']
        result = subprocess.run(cmd, cwd=cwd)
        
        if result.returncode != 0:
            print(f"{env['COLORS']['red']}Rust build failed{env['COLORS']['end']}")
            return result.returncode
        
        # 2. ÂâµÂª∫ Framework ÁµêÊßã
        import shutil
        
        os.makedirs(f'{framework_dir}/Versions/A/Headers', exist_ok=True)
        os.makedirs(f'{framework_dir}/Versions/A/Resources', exist_ok=True)
        
        # Ë§áË£ΩÈùúÊÖãÂ∫´
        lib_src = os.path.join(cwd, f'target/{target_triple}/release/libratamud.a')
        lib_dst = f'{framework_dir}/Versions/A/RataMUD'
        shutil.copy2(lib_src, lib_dst)
        
        # Ë§áË£ΩÈ†≠Êñá‰ª∂
        header_src = os.path.join(cwd, 'src/ratamud.h')
        header_dst = f'{framework_dir}/Versions/A/Headers/ratamud.h'
        shutil.copy2(header_src, header_dst)
        
        # ÂâµÂª∫ Info.plist
        info_plist = f'''<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>RataMUD</string>
    <key>CFBundleIdentifier</key>
    <string>com.ratamud.framework</string>
    <key>CFBundleName</key>
    <string>RataMUD</string>
    <key>CFBundlePackageType</key>
    <string>FMWK</string>
    <key>CFBundleShortVersionString</key>
    <string>0.1.0</string>
</dict>
</plist>'''
        
        with open(f'{framework_dir}/Versions/A/Resources/Info.plist', 'w') as f:
            f.write(info_plist)
        
        # ÂâµÂª∫Á¨¶ËôüÈèàÊé•
        os.chdir(framework_dir)
        for link_name, target_name in [
            ('Headers', 'Versions/A/Headers'),
            ('Resources', 'Versions/A/Resources'),
            ('RataMUD', 'Versions/A/RataMUD'),
            ('Versions/Current', 'A')
        ]:
            if os.path.exists(link_name):
                os.remove(link_name)
            os.symlink(target_name, link_name)
        
        os.chdir(cwd)
        
        print(f"{env['COLORS']['green']}‚úì macOS Framework built: {framework_dir}{env['COLORS']['end']}\n")
        return None
    
    framework_marker = File('#/frameworks/RataMUD.framework/RataMUD')
    framework = local_env.Command(
        framework_marker,
        rust_sources + [cargo_toml],
        build_framework
    )
    
    local_env.Alias('framework', framework)
    
    # ===== iOS Frameworks =====
    def build_ios_frameworks(target, source, env):
        cwd = Dir('#').abspath
        
        print(f"\n{env['COLORS']['cyan']}[iOS] Building iOS Frameworks...{env['COLORS']['end']}")
        
        # Á¢∫‰øù iOS targets Â∑≤ÂÆâË£ù
        for target_triple in ['aarch64-apple-ios', 'aarch64-apple-ios-sim', 'x86_64-apple-ios']:
            subprocess.run(['rustup', 'target', 'add', target_triple], 
                          stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        
        # iOS ÁúüÊ©ü
        print(f"{env['COLORS']['green']}Building for iOS Device (ARM64)...{env['COLORS']['end']}")
        result = subprocess.run([
            env['CARGO'], 'build', '--release', 
            '--target', 'aarch64-apple-ios', 
            '--lib', '--no-default-features'
        ], cwd=cwd)
        if result.returncode != 0:
            return result.returncode
        
        # iOS Ê®°Êì¨Âô® (ARM64)
        print(f"{env['COLORS']['green']}Building for iOS Simulator (ARM64)...{env['COLORS']['end']}")
        result = subprocess.run([
            env['CARGO'], 'build', '--release',
            '--target', 'aarch64-apple-ios-sim',
            '--lib', '--no-default-features'
        ], cwd=cwd)
        if result.returncode != 0:
            return result.returncode
        
        # iOS Ê®°Êì¨Âô® (x86_64)
        print(f"{env['COLORS']['green']}Building for iOS Simulator (x86_64)...{env['COLORS']['end']}")
        result = subprocess.run([
            env['CARGO'], 'build', '--release',
            '--target', 'x86_64-apple-ios',
            '--lib', '--no-default-features'
        ], cwd=cwd)
        if result.returncode != 0:
            return result.returncode
        
        # Âª∫Á´ãÁõÆÈåÑ
        import shutil
        os.makedirs('frameworks/ios-simulator', exist_ok=True)
        
        # Âª∫Á´ãÊ®°Êì¨Âô® Universal Binary
        print(f"{env['COLORS']['cyan']}Creating Simulator Universal Binary...{env['COLORS']['end']}")
        result = subprocess.run([
            'lipo', '-create',
            'target/aarch64-apple-ios-sim/release/libratamud.a',
            'target/x86_64-apple-ios/release/libratamud.a',
            '-output', 'frameworks/ios-simulator/libratamud.a'
        ], cwd=cwd)
        if result.returncode != 0:
            return result.returncode
        
        # Âª∫Á´ã iOS Framework (ÁúüÊ©ü)
        ios_fw = os.path.join(cwd, 'frameworks/RataMUDiOS.framework')
        if os.path.exists(ios_fw):
            shutil.rmtree(ios_fw)
        os.makedirs(f'{ios_fw}/Headers')
        
        shutil.copy2(
            'target/aarch64-apple-ios/release/libratamud.a',
            f'{ios_fw}/RataMUDiOS'
        )
        shutil.copy2('src/ratamud.h', f'{ios_fw}/Headers/')
        
        with open(f'{ios_fw}/Info.plist', 'w') as f:
            f.write('''<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>RataMUDiOS</string>
    <key>CFBundleIdentifier</key>
    <string>com.ratamud.framework.ios</string>
    <key>CFBundleName</key>
    <string>RataMUDiOS</string>
    <key>CFBundlePackageType</key>
    <string>FMWK</string>
    <key>CFBundleShortVersionString</key>
    <string>0.1.0</string>
    <key>MinimumOSVersion</key>
    <string>13.0</string>
</dict>
</plist>
''')
        
        print(f"{env['COLORS']['green']}‚úì iOS Framework: {ios_fw}{env['COLORS']['end']}")
        
        # Âª∫Á´ã iOS Ê®°Êì¨Âô® Framework
        ios_sim_fw = os.path.join(cwd, 'frameworks/RataMUDiOSSimulator.framework')
        if os.path.exists(ios_sim_fw):
            shutil.rmtree(ios_sim_fw)
        os.makedirs(f'{ios_sim_fw}/Headers')
        
        shutil.copy2(
            'frameworks/ios-simulator/libratamud.a',
            f'{ios_sim_fw}/RataMUDiOSSimulator'
        )
        shutil.copy2('src/ratamud.h', f'{ios_sim_fw}/Headers/')
        
        with open(f'{ios_sim_fw}/Info.plist', 'w') as f:
            f.write('''<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>RataMUDiOSSimulator</string>
    <key>CFBundleIdentifier</key>
    <string>com.ratamud.framework.ios-simulator</string>
    <key>CFBundleName</key>
    <string>RataMUDiOSSimulator</string>
    <key>CFBundlePackageType</key>
    <string>FMWK</string>
    <key>CFBundleShortVersionString</key>
    <string>0.1.0</string>
    <key>MinimumOSVersion</key>
    <string>13.0</string>
</dict>
</plist>
''')
        
        print(f"{env['COLORS']['green']}‚úì iOS Simulator Framework: {ios_sim_fw}{env['COLORS']['end']}")
        
        # Âª∫Á´ã XCFramework
        print(f"{env['COLORS']['cyan']}Creating XCFramework...{env['COLORS']['end']}")
        xcframework = os.path.join(cwd, 'frameworks/RataMUD.xcframework')
        if os.path.exists(xcframework):
            shutil.rmtree(xcframework)
        
        result = subprocess.run([
            'xcodebuild', '-create-xcframework',
            '-framework', ios_fw,
            '-framework', ios_sim_fw,
            '-output', xcframework
        ], cwd=cwd)
        
        if result.returncode == 0:
            print(f"{env['COLORS']['green']}‚úì XCFramework: {xcframework}{env['COLORS']['end']}")
        
        print(f"{env['COLORS']['cyan']}üéâ All iOS frameworks built successfully!{env['COLORS']['end']}\n")
        return None
    
    ios_fw_marker = File('#/frameworks/RataMUD.xcframework/Info.plist')
    ios_frameworks = local_env.Command(
        ios_fw_marker,
        rust_sources + [cargo_toml],
        build_ios_frameworks
    )
    
    local_env.Alias('ios-frameworks', ios_frameworks)

# ===== C ÁØÑ‰æã (dylib) =====
c_src = '#/dist/example.c'
if os.path.exists(Dir('#').abspath + '/dist/example.c'):
    c_example = local_env.Program(
        target='#/dist/example',
        source=c_src
    )
    Depends(c_example, rust_lib)
    local_env.Alias('c-example', c_example)
    local_env.Alias('examples', c_example)

# ===== C ÁØÑ‰æã (Framework) =====
if framework_env and os.path.exists(Dir('#').abspath + '/dist/example.c'):
    # ‰ΩøÁî®‰∏çÂêåÁöÑ‰∏≠ÈñìÊñá‰ª∂ÂêçÈÅøÂÖçË°ùÁ™Å
    fw_obj = framework_env.Object(
        target='#/dist/example-fw.o',
        source=c_src
    )
    c_example_fw = framework_env.Program(
        target='#/dist/example-framework',
        source=fw_obj
    )
    Depends(c_example_fw, framework)
    local_env.Alias('c-example-framework', c_example_fw)
    local_env.Alias('example-framework', c_example_fw)

# ===== C++ Ê∏¨Ë©¶ =====
cpp_src = '#/dist/test.cpp'
if os.path.exists(Dir('#').abspath + '/dist/test.cpp'):
    cpp_test = local_env.Program(
        target='#/dist/test',
        source=cpp_src
    )
    Depends(cpp_test, rust_lib)
    local_env.Alias('cpp-test', cpp_test)
    local_env.Alias('examples', cpp_test)

# ===== ÈÅãË°åÊ∏¨Ë©¶ =====
def run_program_action(target, source, env, program_name):
    program = str(source[0])
    print(f"\n{env['COLORS']['cyan']}{'='*60}{env['COLORS']['end']}")
    print(f"{env['COLORS']['green']}Running: {program_name}{env['COLORS']['end']}")
    print(f"{env['COLORS']['cyan']}{'='*60}{env['COLORS']['end']}\n")
    
    # ÂæûÂ∞àÊ°àÊ†πÁõÆÈåÑÂü∑Ë°å‰ª•Ë®™Âïè worlds ÁõÆÈåÑ
    cwd = Dir('#').abspath
    test_env = os.environ.copy()
    if env['RPATH']:
        lib_var = 'DYLD_LIBRARY_PATH' if env['LIB_EXT'] == 'dylib' else 'LD_LIBRARY_PATH'
        dist_path = os.path.join(cwd, env['DIST_DIR'])
        test_env[lib_var] = dist_path + ':' + test_env.get(lib_var, '')
    
    result = subprocess.run([program], env=test_env, cwd=cwd)
    
    if result.returncode != 0:
        print(f"\n{env['COLORS']['red']}‚úó {program_name} failed{env['COLORS']['end']}")
    else:
        print(f"\n{env['COLORS']['green']}‚úì {program_name} completed{env['COLORS']['end']}")
    
    return None

if os.path.exists(Dir('#').abspath + '/dist/example.c'):
    def run_c_action(target, source, env):
        return run_program_action(target, source, env, 'C Example (dylib)')
    
    run_c = local_env.Command(
        'run-c-example',
        '#/dist/example',
        run_c_action
    )
    local_env.Alias('run-c', run_c)
    local_env.AlwaysBuild(run_c)
    
    # Framework ÁâàÊú¨ÈÅãË°å
    if framework_env:
        def run_c_fw_action(target, source, env):
            return run_program_action(target, source, env, 'C Example (Framework)')
        
        run_c_fw = local_env.Command(
            'run-c-example-framework',
            '#/dist/example-framework',
            run_c_fw_action
        )
        local_env.Alias('run-framework', run_c_fw)
        local_env.AlwaysBuild(run_c_fw)

if os.path.exists(Dir('#').abspath + '/dist/test.cpp'):
    def run_cpp_action(target, source, env):
        return run_program_action(target, source, env, 'C++ Test')
    
    run_cpp = local_env.Command(
        'run-cpp-test',
        '#/dist/test',
        run_cpp_action
    )
    local_env.Alias('run-cpp', run_cpp)
    local_env.AlwaysBuild(run_cpp)

# ===== Ê∏ÖÁêÜ =====
Clean(rust_lib, [local_env['RUST_TARGET_DIR']])

# ËøîÂõû
Return('rust_lib')
