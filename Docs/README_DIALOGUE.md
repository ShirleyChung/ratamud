# NPC 對話系統說明

## 概述
新的對話系統支援多個對話選項和條件判斷，NPC 會根據自身屬性、持有物品等條件來選擇合適的對話內容。

## 基本概念

### 話題（Topic）
- 對話被組織成不同的話題，如「見面」、「閒聊」等
- 每個話題可以有多個對話選項
- talk 命令預設話題為「閒聊」

### 對話選項（DialogueOption）
- 每個選項包含對話文字和觸發條件
- 條件滿足時，該選項才會被納入候選
- 可以設定權重來調整被選中的機率

### 條件（Condition）
- 支援多種屬性判斷：hp, mp, 力量, 知識, 交誼, 性別, 顏值等
- 支援物品數量判斷：物品數量, item:物品名
- 支援運算子：>, <, >=, <=, =, !=
- 多個條件用 "and" 連接（AND 關係）

## 命令使用

### 1. talk - 與 NPC 對話
```
talk <NPC名稱> [話題]
```
- 話題參數可省略，預設為「閒聊」
- 範例：
  - `talk 商人` - 與商人閒聊
  - `talk 櫻花 見面` - 跟櫻花打招呼
  - `talk 工人 閒聊` - 與工人閒聊

### 2. setdialogue / sdl - 設置 NPC 對話

sdl 命令支援三種語法：

#### 語法 1：簡單版（無條件）
```
sdl <NPC> <話題> <對話內容>
```
範例：
```
sdl 商人 見面 哈囉！你好，來看看我的商品
sdl 櫻花 閒聊 今天天氣真好呢
```

#### 語法 2：add 語法（帶條件）
```
sdl <NPC> <話題> add <對話內容> when <條件>
```
範例：
```
sdl 櫻花 閒聊 add 你長得好漂亮啊 when 顏值>80 and 性別=女
sdl 工人 閒聊 add 這個工程真不好做 when mp<98000
```

#### 語法 3：set 語法（條件式，更直觀）
```
sdl <NPC> set <話題> when <條件> say <對話內容>
```
範例：
```
sdl ammy set 閒聊 when 力量>100 and 顏值>80 say 你真是又帥又厲害
sdl 商人 set 閒聊 when 物品數量>5 say 要不要賣些東西給我
sdl 櫻花 set 見面 when mp>500 and 性別=女 say 你好！你看起來精神很好呢
```

**三種語法的差異**：
- **語法 1**（簡單版）：最簡潔，適合無條件對話
- **語法 2**（add）：原有語法，條件在後面
- **語法 3**（set）：新語法，條件在中間，用 `say` 引出對話內容，語意更清晰

## 支援的屬性

### Person 基本屬性
- `hp`, `mp`, `max_hp`, `max_mp` - 生命值和精神力
- `strength` / `力量` - 力量值
- `knowledge` / `知識` - 知識值
- `sociality` / `交誼` - 交誼值
- `age` / `年齡` - 年齡（秒）
- `relationship` / `好感度` - 好感度 (-100 到 100)
- `talk_eagerness` / `積極度` - 說話積極度 (0-100)

### 新增屬性
- `gender` / `性別` - 性別（字串，如「男」、「女」、「未知」）
- `appearance` / `顏值` - 顏值 (0-100)

### 物品相關
- `items_count` / `物品數量` - 持有物品總數量
- `item:物品名` - 持有特定物品的數量
  - 範例：`item:麵包>3` 表示持有超過 3 個麵包

## 實際範例

### 範例 1：工人的閒聊
```bash
# 創建工人
create person 工人 辛勤工作的人
summon 工人
set 工人 性別 男

# 設置對話（使用不同語法）
sdl 工人 見面 嘿！工作辛苦了！
sdl 工人 閒聊 明天就可以放假了
sdl 工人 set 閒聊 when mp<98000 say 這個工程真不好做
sdl 工人 set 閒聊 when mp>98000 say 今天狀態很好！

# 測試對話
talk 工人 見面
talk 工人 閒聊
```

### 範例 2：櫻花的條件對話
```bash
# 創建櫻花
create person 櫻花 可愛的女孩
summon 櫻花
set 櫻花 性別 女
set 櫻花 顏值 85
set 櫻花 mp 600

# 設置對話（使用 set 語法）
sdl 櫻花 見面 你好啊！很高興見到你
sdl 櫻花 閒聊 今天天氣真好呢
sdl 櫻花 set 閒聊 when 顏值>80 and 性別=女 say 你長得好漂亮啊
sdl 櫻花 set 閒聊 when mp>500 say 你看起來精神很好

# 測試對話（會根據條件選擇不同回應）
talk 櫻花 閒聊
```

### 範例 3：商人依物品數量
```bash
# 創建商人
create person 商人 精明的商人
summon 商人

# 設置對話
sdl 商人 閒聊 歡迎光臨！
sdl 商人 set 閒聊 when 物品數量>5 say 要不要賣些東西給我
sdl 商人 set 閒聊 when 物品數量<3 say 看來你身無長物啊

# 測試（撿起物品後對話會改變）
talk 商人 閒聊
get 麵包
get 火把
get 繩索
talk 商人 閒聊
```

### 範例 4：使用 set 語法的複雜條件
```bash
# 創建 NPC
create person ammy 帥氣的冒險者
summon ammy
set ammy 性別 男
set ammy 力量 120
set ammy 顏值 85

# 使用 set 語法設置對話
sdl ammy set 閒聊 when 力量>100 and 顏值>80 say 你真是又帥又厲害
sdl ammy set 閒聊 when 力量>100 and 顏值<80 say 你的力量很強
sdl ammy set 見面 when 性別=男 say 兄弟，好久不見！

# 測試
talk ammy 閒聊
talk ammy 見面
```

## 對話選擇機制

1. **積極度檢查**：首先根據 NPC 的 `talk_eagerness`（說話積極度）決定是否回應
2. **條件過濾**：檢查所有對話選項的條件，**根據玩家（對話發起者）的屬性**過濾出滿足條件的選項
3. **加權隨機**：在滿足條件的選項中，根據權重隨機選擇一個
4. **無選項處理**：如果沒有任何選項滿足條件，NPC 不會回應該話題

### 重要說明 ⭐
- **條件評估對象**：對話條件是根據**玩家**的屬性來評估，而非 NPC 自己的屬性
- 例如：`when 顏值>80 and 性別=女` 是檢查**玩家**的顏值和性別，而非 NPC 的
- 這樣 NPC 可以根據玩家的狀態給出不同的回應
- 範例：
  ```bash
  # 玩家的顏值 > 80 且性別為女時，櫻花會說這句話
  sdl 櫻花 set 閒聊 when 顏值>80 and 性別=女 say 你長得好漂亮啊
  
  # 玩家的物品數量 > 5 時，商人會說這句話
  sdl 商人 set 閒聊 when 物品數量>5 say 要不要賣些東西給我
  ```

## 設置 NPC 屬性

使用 `set` 命令設置 NPC 的性別和顏值：
```bash
set <NPC> 性別 <值>    # 值：男、女、未知等
set <NPC> 顏值 <數字>  # 數字：0-100
```

範例：
```bash
set 櫻花 性別 女
set 櫻花 顏值 85
set 工人 性別 男
set 工人 顏值 60
```

## 查看 NPC 對話設置

使用 `check` 命令查看 NPC 的詳細資訊，包括所有對話選項：
```bash
check <NPC名稱>
```

這會顯示：
- NPC 的基本屬性（包括性別和顏值）
- 所有話題和對應的對話選項數量
- 每個選項的文字預覽和條件數量

## 注意事項

1. **條件語法**：條件中的 "and" 兩側需要有空格
2. **運算子優先級**：>= 和 <= 必須寫在 > 和 < 之前解析
3. **字串比較**：性別等字串屬性使用 = 或 != 進行比較
4. **數字比較**：數值屬性可使用所有運算子
5. **向後兼容**：舊的簡單對話格式仍然支援，會自動轉換為無條件選項

## 三種 sdl 語法選擇建議

- **簡單對話**：使用語法 1（`sdl <NPC> <話題> <對話>`）
- **有條件但語句簡短**：使用語法 2（`sdl <NPC> <話題> add <對話> when <條件>`）
- **有條件且想清楚表達**：使用語法 3（`sdl <NPC> set <話題> when <條件> say <對話>`）

語法 3 的優點：
- 條件在前，對話在後，邏輯更清晰
- `say` 關鍵字明確標示對話內容開始
- 適合複雜條件的情況
