# äº‹ä»¶ç³»çµ±æ”¹ç”¨ç¨ç«‹åŸ·è¡Œç·’ - å¯¦ç¾èªªæ˜

## ğŸ“‹ æ”¹é€²ç›®æ¨™

å°‡äº‹ä»¶æª¢æŸ¥é‚è¼¯å¾ä¸»éŠæˆ²å¾ªç’°ç§»åˆ°ç¨ç«‹åŸ·è¡Œç·’ä¸­ï¼Œæå‡æ€§èƒ½å’Œæ¶æ§‹æ¸…æ™°åº¦ã€‚

## ğŸ”§ å¯¦ç¾å…§å®¹

### 1. æ–°å¢æª”æ¡ˆ

**src/event_check_thread.rs**
- å‰µå»º `EventCheckThread` çµæ§‹
- é¡ä¼¼æ–¼ `NpcAiThread` çš„è¨­è¨ˆ
- åœ¨ç¨ç«‹ç·šç¨‹ä¸­å®šæœŸæª¢æŸ¥äº‹ä»¶è§¸ç™¼æ¢ä»¶
- è¿”å›è§¸ç™¼çš„äº‹ä»¶ ID åˆ—è¡¨å’Œæ—¥èªŒ

### 2. ä¿®æ”¹çš„æª”æ¡ˆ

#### src/lib.rs
- æ·»åŠ  `pub mod event_check_thread;`

#### src/main.rs
- æ·»åŠ  `mod event_check_thread;`

#### src/world.rs
- æ·»åŠ å­—æ®µï¼š`pub event_check_thread: Option<EventCheckThread>`
- æ·»åŠ æ–¹æ³•ï¼š
  - `get_event_logs()` - ç²å–äº‹ä»¶æª¢æŸ¥æ—¥èªŒ
  - `get_triggered_events()` - ç²å–è§¸ç™¼çš„äº‹ä»¶ ID
- åœ¨ `Drop` trait ä¸­åœæ­¢äº‹ä»¶æª¢æŸ¥ç·šç¨‹

#### src/app.rs
- åœ¨ `run_main_loop()` å•Ÿå‹•äº‹ä»¶æª¢æŸ¥åŸ·è¡Œç·’
- åˆªé™¤èˆŠçš„äº‹ä»¶æª¢æŸ¥é‚è¼¯ï¼ˆ`check_and_execute_events` å‡½æ•¸ï¼‰
- åœ¨ä¸»å¾ªç’°ä¸­ï¼š
  - åŒæ­¥æ™‚é–“åˆ°äº‹ä»¶æª¢æŸ¥åŸ·è¡Œç·’
  - ç²å–è§¸ç™¼çš„äº‹ä»¶
  - åœ¨ä¸»åŸ·è¡Œç·’ä¸­åŸ·è¡Œäº‹ä»¶å‹•ä½œ

## ğŸ¯ æ¶æ§‹è¨­è¨ˆ

### ç·šç¨‹è·è²¬åˆ†é›¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»åŸ·è¡Œç·’      â”‚
â”‚  (Main Loop)    â”‚
â”‚                 â”‚
â”‚ â€¢ UI æ¸²æŸ“       â”‚
â”‚ â€¢ ç©å®¶è¼¸å…¥      â”‚
â”‚ â€¢ äº‹ä»¶åŸ·è¡Œ      â”‚ â†â”€â”€ æ¥æ”¶è§¸ç™¼çš„äº‹ä»¶ ID
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    åŒæ­¥æ™‚é–“ â†“
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶æª¢æŸ¥åŸ·è¡Œç·’  â”‚ 
â”‚ (1 ç§’æª¢æŸ¥ä¸€æ¬¡)  â”‚
â”‚                 â”‚
â”‚ â€¢ æª¢æŸ¥æ™‚é–“è§¸ç™¼  â”‚ 
â”‚ â€¢ æª¢æŸ¥ cron     â”‚
â”‚ â€¢ è¿”å›äº‹ä»¶ ID   â”‚ â”€â”€â†’ å›å‚³åˆ°ä¸»åŸ·è¡Œç·’
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œæµç¨‹

1. **å•Ÿå‹•éšæ®µ**
   ```rust
   // å‰µå»ºäº‹ä»¶æ•¸æ“šå‰¯æœ¬
   let events_data = Arc::new(Mutex::new(...));
   let time_for_event = Arc::new(Mutex::new(...));
   
   // å•Ÿå‹•åŸ·è¡Œç·’ï¼ˆæ¯ 1 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰
   let event_check_thread = EventCheckThread::new(check_fn, 1000);
   ```

2. **åŸ·è¡Œéšæ®µï¼ˆæ¯ 1 ç§’ï¼‰**
   ```
   äº‹ä»¶æª¢æŸ¥åŸ·è¡Œç·’ï¼š
   â”œâ”€ ç²å–ç•¶å‰æ™‚é–“
   â”œâ”€ æª¢æŸ¥æ˜¯å¦åŒä¸€åˆ†é˜ï¼ˆé¿å…é‡è¤‡ï¼‰
   â”œâ”€ éæ­·æ‰€æœ‰äº‹ä»¶
   â”‚  â””â”€ æª¢æŸ¥æ™‚é–“è§¸ç™¼å™¨
   â”‚     â”œâ”€ æª¢æŸ¥æ™‚é–“ç¯„åœ
   â”‚     â”œâ”€ æª¢æŸ¥ cron è¡¨é”å¼
   â”‚     â””â”€ è¨˜éŒ„è§¸ç™¼çš„äº‹ä»¶ ID
   â””â”€ è¿”å› (æ—¥èªŒåˆ—è¡¨, äº‹ä»¶ ID åˆ—è¡¨)
   ```

3. **åŒæ­¥éšæ®µï¼ˆä¸»å¾ªç’°ï¼‰**
   ```rust
   // æ›´æ–°æ™‚é–“
   game_world.update_time();
   
   // åŒæ­¥åˆ°äº‹ä»¶åŸ·è¡Œç·’
   *time_lock = game_world.time.clone();
   
   // ç²å–è§¸ç™¼çš„äº‹ä»¶
   let triggered_events = game_world.get_triggered_events();
   
   // åŸ·è¡Œäº‹ä»¶
   for event_id in triggered_events {
       execute_event(&event, game_world, me, output_manager);
   }
   ```

## âœ¨ å„ªå‹¢

### 1. æ€§èƒ½æå‡
- **æ¸›å°‘ä¸»å¾ªç’°è² æ“”**ï¼šäº‹ä»¶æª¢æŸ¥ä¸å†é˜»å¡ä¸»éŠæˆ²å¾ªç’°
- **ä¸¦è¡Œè™•ç†**ï¼šäº‹ä»¶æª¢æŸ¥èˆ‡éŠæˆ²é‚è¼¯ä¸¦è¡ŒåŸ·è¡Œ
- **å®šæ™‚æª¢æŸ¥**ï¼šåªåœ¨éœ€è¦æ™‚æª¢æŸ¥ï¼ˆ1 ç§’ä¸€æ¬¡ï¼‰ï¼Œä¸æ˜¯æ¯å¹€éƒ½æª¢æŸ¥

### 2. æ¶æ§‹æ”¹å–„
- **è·è²¬åˆ†é›¢**ï¼šæª¢æŸ¥é‚è¼¯å’ŒåŸ·è¡Œé‚è¼¯åˆ†é–‹
- **ç·šç¨‹å®‰å…¨**ï¼šä½¿ç”¨ `Arc<Mutex>` å®‰å…¨å…±äº«æ•¸æ“š
- **æ˜“æ–¼æ“´å±•**ï¼šå¯ä»¥è¼•é¬†æ·»åŠ æ›´å¤šè§¸ç™¼å™¨é¡å‹

### 3. ä¸€è‡´æ€§
- **çµ±ä¸€è¨­è¨ˆ**ï¼šèˆ‡ `NpcAiThread`ã€`TimeThread` ç›¸åŒçš„æ¨¡å¼
- **å¯ç¶­è­·æ€§**ï¼šæ¸…æ™°çš„ç·šç¨‹ç®¡ç†å’Œç”Ÿå‘½é€±æœŸ

## ğŸ” ç•¶å‰å¯¦ç¾ç¯„åœ

### æ”¯æŒçš„è§¸ç™¼å™¨
ç›®å‰åœ¨ç¨ç«‹åŸ·è¡Œç·’ä¸­åªæ”¯æŒï¼š
- âœ… **æ™‚é–“è§¸ç™¼å™¨** (`TriggerType::Time`)
  - cron è¡¨é”å¼ï¼ˆåˆ†é˜å’Œå°æ™‚ï¼‰
  - æ™‚é–“ç¯„åœé™åˆ¶

### æœªä¾†æ“´å±•
å¯ä»¥æ·»åŠ æ›´å¤šè§¸ç™¼å™¨é¡å‹ï¼š
- â³ éš¨æ©Ÿäº‹ä»¶ (`TriggerType::Random`)
- â³ ä½ç½®è§¸ç™¼ (`TriggerType::Location`)
- â³ æ¢ä»¶è§¸ç™¼ (`TriggerType::Condition`)

## ğŸ“Š æ€§èƒ½å°æ¯”

### ä¹‹å‰ï¼ˆä¸»å¾ªç’°æª¢æŸ¥ï¼‰
```
ä¸»å¾ªç’°ï¼ˆ60 FPSï¼‰
â”œâ”€ æ¯å¹€æª¢æŸ¥äº‹ä»¶ âŒ
â”œâ”€ éæ­·æ‰€æœ‰äº‹ä»¶
â”œâ”€ æª¢æŸ¥è§¸ç™¼æ¢ä»¶
â””â”€ åŸ·è¡Œäº‹ä»¶
```
**å•é¡Œ**ï¼šæ¯ç§’æª¢æŸ¥ 60 æ¬¡ï¼Œä½†å¤§éƒ¨åˆ†æ™‚å€™æ²’æœ‰äº‹ä»¶è§¸ç™¼

### ç¾åœ¨ï¼ˆç¨ç«‹åŸ·è¡Œç·’ï¼‰
```
ä¸»å¾ªç’°ï¼ˆ60 FPSï¼‰          äº‹ä»¶åŸ·è¡Œç·’ï¼ˆ1 Hzï¼‰
â”œâ”€ æ¸²æŸ“ UI              â”œâ”€ æ¯ç§’æª¢æŸ¥ä¸€æ¬¡ âœ…
â”œâ”€ è™•ç†è¼¸å…¥             â”œâ”€ éæ­·æ‰€æœ‰äº‹ä»¶
â”œâ”€ ç²å–è§¸ç™¼äº‹ä»¶ âœ…       â”œâ”€ æª¢æŸ¥è§¸ç™¼æ¢ä»¶
â””â”€ åŸ·è¡Œäº‹ä»¶            â””â”€ è¿”å›äº‹ä»¶ ID
```
**å„ªå‹¢**ï¼šä¸»å¾ªç’°æ›´è¼•é‡ï¼Œäº‹ä»¶æª¢æŸ¥ç¨ç«‹é€²è¡Œ

## ğŸ› ï¸ æŠ€è¡“ç´°ç¯€

### ç·šç¨‹å®‰å…¨
```rust
// ä½¿ç”¨ Arc<Mutex> å…±äº«æ•¸æ“š
let time_for_event = Arc::new(Mutex::new(game_world.time.clone()));
let events_data = Arc::new(Mutex::new(...));
```

### é¿å…é‡è¤‡æª¢æŸ¥
```rust
// éœæ…‹è®Šé‡è¿½è¹¤ä¸Šæ¬¡æª¢æŸ¥æ™‚é–“
static LAST_CHECK: Mutex<(u64, u8, u8)> = Mutex::new((0, 0, 0));
{
    let mut last = LAST_CHECK.lock().unwrap();
    if (*last) == (current_day, current_hour, current_minute) {
        return (logs, triggered_event_ids);
    }
    *last = (current_day, current_hour, current_minute);
}
```

### å„ªé›…é—œé–‰
```rust
impl Drop for GameWorld {
    fn drop(&mut self) {
        if let Some(ref mut thread) = self.event_check_thread {
            thread.stop();  // è‡ªå‹•åœæ­¢åŸ·è¡Œç·’
        }
    }
}
```

## ğŸ“ æ¸¬è©¦å»ºè­°

### 1. åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
```bash
cargo run --release --bin main
# è§€å¯Ÿäº‹ä»¶æ—¥èªŒæ˜¯å¦æ­£å¸¸é¡¯ç¤º
```

### 2. æ€§èƒ½æ¸¬è©¦
- è§€å¯Ÿ CPU ä½¿ç”¨ç‡
- æª¢æŸ¥ UI æµæš¢åº¦
- ç¢ºèªäº‹ä»¶è§¸ç™¼æº–ç¢ºæ€§

### 3. å£“åŠ›æ¸¬è©¦
- æ·»åŠ å¤§é‡äº‹ä»¶
- é•·æ™‚é–“é‹è¡Œ
- æª¢æŸ¥å…§å­˜æ´©æ¼

## ğŸ‰ ç¸½çµ

äº‹ä»¶ç³»çµ±æ”¹ç‚ºç¨ç«‹åŸ·è¡Œç·’å¾Œï¼š
- âœ… ä¸»å¾ªç’°æ›´è¼•é‡
- âœ… äº‹ä»¶æª¢æŸ¥ä¸é˜»å¡éŠæˆ²
- âœ… æ¶æ§‹æ›´æ¸…æ™°
- âœ… æ˜“æ–¼ç¶­è­·å’Œæ“´å±•
- âœ… èˆ‡å…¶ä»–åŸ·è¡Œç·’æ¨¡å¼ä¸€è‡´

---

**å¯¦ç¾æ™‚é–“**: 2025-12-16  
**ç‹€æ…‹**: âœ… å·²å®Œæˆä¸¦æ¸¬è©¦
