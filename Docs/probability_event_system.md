# æ©Ÿç‡æ¬Šé‡äº‹ä»¶ç³»çµ±

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ç‚ºäº‹ä»¶ç³»çµ±æ–°å¢äº†æ©Ÿç‡æ¬Šé‡åŠŸèƒ½ï¼Œå…è¨±äº‹ä»¶æ ¹æ“šè¨­å®šçš„æ©Ÿç‡åŸ·è¡Œä¸åŒçš„å‹•ä½œã€‚é€™å°æ–¼å‰µå»ºå‹•æ…‹çš„éŠæˆ²ç’°å¢ƒï¼ˆå¦‚å¤©æ°£ç³»çµ±ã€éš¨æ©Ÿäº‹ä»¶ç­‰ï¼‰éå¸¸æœ‰ç”¨ã€‚

## æ–°å¢åŠŸèƒ½

### 1. åœ°åœ–å±¬æ€§ç³»çµ± (Map Properties)

åœ°åœ–ç¾åœ¨å¯ä»¥å„²å­˜è‡ªå®šç¾©å±¬æ€§ï¼Œç”¨æ–¼è¨˜éŒ„åœ°åœ–çš„å‹•æ…‹ç‹€æ…‹ã€‚

#### ç¨‹å¼ç¢¼è®Šæ›´
åœ¨ `src/map.rs` ä¸­ï¼š
```rust
pub struct Map {
    // ... å…¶ä»–æ¬„ä½
    pub properties: HashMap<String, String>,  // æ–°å¢ï¼šåœ°åœ–è‡ªå®šç¾©å±¬æ€§
}

// æ–°å¢æ–¹æ³•
pub fn set_property(&mut self, key: String, value: String)
pub fn get_property(&self, key: &str) -> Option<&String>
```

#### ä½¿ç”¨ç¯„ä¾‹
```rust
// è¨­å®šå¤©æ°£å±¬æ€§
map.set_property("å¤©æ°£".to_string(), "æ™´å¤©".to_string());

// ç²å–å¤©æ°£å±¬æ€§
if let Some(weather) = map.get_property("å¤©æ°£") {
    println!("ç•¶å‰å¤©æ°£: {}", weather);
}
```

### 2. éš¨æ©Ÿå‹•ä½œ (RandomAction)

æ–°çš„äº‹ä»¶å‹•ä½œé¡å‹ï¼Œå¯ä»¥æ ¹æ“šæ¬Šé‡éš¨æ©ŸåŸ·è¡Œä¸åŒçš„å‹•ä½œã€‚

#### äº‹ä»¶å‹•ä½œå®šç¾©
åœ¨ `src/event.rs` ä¸­ï¼š
```rust
#[serde(rename = "random_action")]
RandomAction {
    actions: Vec<WeightedAction>,
}

pub struct WeightedAction {
    pub weight: f32,  // æ¬Šé‡ï¼ˆæ©Ÿç‡ï¼‰
    pub action: Box<EventAction>,
}
```

#### JSON æ ¼å¼
```json
{
  "type": "random_action",
  "actions": [
    {
      "weight": 0.3,
      "action": {
        "type": "message",
        "text": "æ™´å¤©è¨Šæ¯"
      }
    },
    {
      "weight": 0.7,
      "action": {
        "type": "message",
        "text": "é›¨å¤©è¨Šæ¯"
      }
    }
  ]
}
```

#### æ¬Šé‡èªªæ˜
- æ¬Šé‡å¯ä»¥æ˜¯ä»»æ„æ­£æ•¸ï¼ˆä¸é™æ–¼ 0-1 ä¹‹é–“ï¼‰
- ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—ç¸½æ¬Šé‡ä¸¦æŒ‰æ¯”ä¾‹åˆ†é…æ©Ÿç‡
- ä¾‹å¦‚ï¼š
  - æ¬Šé‡ [0.3, 0.7] â†’ æ©Ÿç‡ 30%, 70%
  - æ¬Šé‡ [3, 7] â†’ æ©Ÿç‡ 30%, 70%ï¼ˆç›¸åŒçµæœï¼‰
  - æ¬Šé‡ [1, 2, 3] â†’ æ©Ÿç‡ 16.7%, 33.3%, 50%

### 3. è¨­å®šåœ°åœ–å±¬æ€§å‹•ä½œ (SetMapProperty)

æ–°çš„äº‹ä»¶å‹•ä½œï¼Œç”¨æ–¼ä¿®æ”¹åœ°åœ–çš„è‡ªå®šç¾©å±¬æ€§ã€‚

#### äº‹ä»¶å‹•ä½œå®šç¾©
```rust
#[serde(rename = "set_map_property")]
SetMapProperty {
    map: String,      // åœ°åœ–åç¨±
    property: String, // å±¬æ€§åç¨±
    value: String,    // å±¬æ€§å€¼
}
```

#### JSON æ ¼å¼
```json
{
  "type": "set_map_property",
  "map": "beginMap",
  "property": "å¤©æ°£",
  "value": "æ™´å¤©"
}
```

## å¤©æ°£ç³»çµ±ç¯„ä¾‹

### åŸºæœ¬å¤©æ°£äº‹ä»¶ (weather_event.json)

æª”æ¡ˆä½ç½®ï¼š`worlds/beginWorld/events/weather_event.json`

åŠŸèƒ½ï¼š
- æ¯ 5 åˆ†é˜è§¸ç™¼ä¸€æ¬¡
- éš¨æ©Ÿé¸æ“‡ä¸€ç¨®å¤©æ°£ï¼ˆæ™´å¤©ã€é™°å¤©ã€é›¨å¤©ã€å¤šé›²ã€éœ§å¤©ï¼‰
- æ›´æ–° beginMap çš„ã€Œå¤©æ°£ã€å±¬æ€§
- é¡¯ç¤ºå°æ‡‰çš„å¤©æ°£æè¿°

æ©Ÿç‡åˆ†å¸ƒï¼š
| å¤©æ°£ | æ¬Šé‡ | æ©Ÿç‡ | è¨Šæ¯ |
|------|------|------|------|
| æ™´å¤© | 0.3  | 30%  | â˜€ï¸ å¤©ç©ºæ”¾æ™´äº†ï¼Œé™½å…‰ç‘æ»¿å¤§åœ° |
| é™°å¤© | 0.25 | 25%  | â˜ï¸ å¤©ç©ºè®Šå¾—é™°æ²‰ï¼Œçƒé›²å¯†å¸ƒ |
| é›¨å¤© | 0.2  | 20%  | ğŸŒ§ï¸ é–‹å§‹ä¸‹èµ·é›¨ä¾† |
| å¤šé›² | 0.15 | 15%  | â›… å¤©ç©ºé£„è‘—å¹¾æœµç™½é›² |
| éœ§å¤© | 0.1  | 10%  | ğŸŒ«ï¸ æ¿ƒéœ§ç€°æ¼«ï¼Œèƒ½è¦‹åº¦å¾ˆä½ |

### ç’°å¢ƒäº‹ä»¶ (environment_events.json)

æª”æ¡ˆä½ç½®ï¼š`worlds/beginWorld/events/environment_events.json`

åŒ…å«å…©å€‹äº‹ä»¶ï¼š

#### 1. æ£®æ—å¤©æ°£è®ŠåŒ–
- è§¸ç™¼é »ç‡ï¼šæ¯ 8 åˆ†é˜
- å†·å»æ™‚é–“ï¼š480 ç§’
- ç‰¹è‰²ï¼šæ£®æ—åœ°åœ–å¤šéœ§å¤šé›¨ï¼ˆéœ§å¤© 25%ï¼Œé›¨å¤© 30%ï¼‰

#### 2. æº«åº¦è®ŠåŒ–
- è§¸ç™¼é »ç‡ï¼šæ¯ 10 åˆ†é˜ï¼ˆ70% æ©Ÿç‡è§¸ç™¼ï¼‰
- å†·å»æ™‚é–“ï¼š600 ç§’
- æº«åº¦ç­‰ç´šï¼šç‚ç†±(10%)ã€æº«æš–(30%)ã€èˆ’é©(40%)ã€æ¶¼çˆ½(15%)ã€å¯’å†·(5%)

## å¯¦ä½œç´°ç¯€

### éš¨æ©Ÿå‹•ä½œåŸ·è¡Œé‚è¼¯

åœ¨ `src/event_executor.rs` ä¸­ï¼š

```rust
fn execute_random_action(
    weighted_actions: &[WeightedAction],
    game_world: &mut GameWorld,
    output_manager: &mut OutputManager,
) -> Result<(), String> {
    // 1. è¨ˆç®—ç¸½æ¬Šé‡
    let total_weight: f32 = weighted_actions.iter().map(|a| a.weight).sum();
    
    // 2. ç”Ÿæˆ 0 åˆ° total_weight ä¹‹é–“çš„éš¨æ©Ÿæ•¸
    let mut random_value = rng.gen::<f32>() * total_weight;
    
    // 3. éæ­·å‹•ä½œï¼Œæ¸›å»æ¬Šé‡ï¼Œç•¶ random_value <= 0 æ™‚åŸ·è¡Œè©²å‹•ä½œ
    for weighted_action in weighted_actions {
        random_value -= weighted_action.weight;
        if random_value <= 0.0 {
            return Self::execute_action(&weighted_action.action, game_world, output_manager);
        }
    }
}
```

### åŸ·è¡Œæµç¨‹åœ–

```
äº‹ä»¶è§¸ç™¼
    â†“
æª¢æŸ¥è§¸ç™¼æ¢ä»¶ï¼ˆæ™‚é–“ã€ä½ç½®ç­‰ï¼‰
    â†“
åŸ·è¡Œå‹•ä½œåˆ—è¡¨
    â†“
é‡åˆ° random_action
    â†“
1. è¨ˆç®—ç¸½æ¬Šé‡ (Î£weight)
2. ç”Ÿæˆéš¨æ©Ÿæ•¸ r âˆˆ [0, Î£weight)
3. æ‰¾åˆ°å°æ‡‰çš„å‹•ä½œä¸¦åŸ·è¡Œ
    â†“
æ›´æ–°äº‹ä»¶ç‹€æ…‹ï¼ˆè§¸ç™¼æ¬¡æ•¸ã€å†·å»æ™‚é–“ç­‰ï¼‰
```

## é€²éšæ‡‰ç”¨

### 1. çµ„åˆå¤šå€‹éš¨æ©Ÿå‹•ä½œ

ä¸€å€‹äº‹ä»¶å¯ä»¥åŒ…å«å¤šå€‹ç¨ç«‹çš„ `random_action`ï¼š

```json
{
  "actions": [
    {
      "type": "random_action",
      "actions": [/* å¤©æ°£é¸æ“‡ */]
    },
    {
      "type": "random_action",
      "actions": [/* é¢¨åŠ›é¸æ“‡ */]
    },
    {
      "type": "random_action",
      "actions": [/* æº«åº¦é¸æ“‡ */]
    }
  ]
}
```

### 2. å·¢ç‹€éš¨æ©Ÿå‹•ä½œ

ç†è«–ä¸Šå¯ä»¥å°‡ `random_action` æ”¾åœ¨å¦ä¸€å€‹ `random_action` çš„å‹•ä½œä¸­ï¼š

```json
{
  "type": "random_action",
  "actions": [
    {
      "weight": 0.5,
      "action": {
        "type": "random_action",
        "actions": [/* æ™´å¤©çš„ä¸åŒè®ŠåŒ– */]
      }
    },
    {
      "weight": 0.5,
      "action": {
        "type": "message",
        "text": "é›¨å¤©"
      }
    }
  ]
}
```

### 3. æ··åˆç¢ºå®šæ€§èˆ‡éš¨æ©Ÿæ€§å‹•ä½œ

```json
{
  "actions": [
    {
      "type": "message",
      "text": "å¤©æ°£æ­£åœ¨è®ŠåŒ–..."
    },
    {
      "type": "random_action",
      "actions": [/* éš¨æ©Ÿé¸æ“‡å¤©æ°£ */]
    },
    {
      "type": "message",
      "text": "å¤©æ°£è®ŠåŒ–å®Œæˆã€‚"
    }
  ]
}
```

## æ¸¬è©¦æ–¹æ³•

### 1. æª¢æŸ¥äº‹ä»¶è¼‰å…¥
å•Ÿå‹•éŠæˆ²å¾Œï¼Œç¢ºèªäº‹ä»¶å·²æ­£ç¢ºè¼‰å…¥ï¼š
```
ç¸½å…±è¼‰å…¥äº† X å€‹äº‹ä»¶ã€‚
```

### 2. è§€å¯Ÿå¤©æ°£è®ŠåŒ–
- ç­‰å¾… 5-10 åˆ†é˜
- æ‡‰è©²æœƒçœ‹åˆ°å¤©æ°£è®ŠåŒ–çš„è¨Šæ¯
- è¨Šæ¯æ‡‰ç¬¦åˆè¨­å®šçš„æ©Ÿç‡åˆ†å¸ƒ

### 3. é•·æœŸçµ±è¨ˆï¼ˆå¯é¸ï¼‰
å¯ä»¥ä¿®æ”¹ç¨‹å¼ç¢¼è¨˜éŒ„å„ç¨®å¤©æ°£å‡ºç¾çš„æ¬¡æ•¸ï¼Œé©—è­‰æ©Ÿç‡åˆ†å¸ƒæ˜¯å¦æ­£ç¢ºã€‚

## æœªä¾†æ“´å±•å»ºè­°

### 1. å­£ç¯€ç³»çµ±
æ ¹æ“šéŠæˆ²å…§çš„æœˆä»½èª¿æ•´å¤©æ°£æ©Ÿç‡ï¼š
```rust
// å¤å­£ï¼šå¢åŠ ç‚ç†±å’Œæ™´å¤©æ©Ÿç‡
// å†¬å­£ï¼šå¢åŠ å¯’å†·å’Œé›ªå¤©æ©Ÿç‡
```

### 2. å¤©æ°£æ•ˆæœ
ä¸åŒå¤©æ°£å½±éŸ¿éŠæˆ²ç©æ³•ï¼š
- é›¨å¤©ï¼šç§»å‹•é€Ÿåº¦ -10%
- éœ§å¤©ï¼šè¦–é‡ç¯„åœ -2
- æ™´å¤©ï¼šå¿ƒæƒ… +5

### 3. å¤©æ°£é€£é–
å‰ä¸€å€‹å¤©æ°£å½±éŸ¿ä¸‹ä¸€å€‹å¤©æ°£çš„æ©Ÿç‡ï¼š
- é›¨å¤© â†’ é™°å¤©ï¼ˆé«˜æ©Ÿç‡ï¼‰
- æ™´å¤© â†’ é›¨å¤©ï¼ˆä½æ©Ÿç‡ï¼‰

### 4. å€åŸŸç‰¹è‰²å¤©æ°£
ä¸åŒåœ°åœ–é¡å‹æœ‰ä¸åŒçš„å¤©æ°£æ¨¡å¼ï¼š
- æ²™æ¼ ï¼šå¾ˆå°‘ä¸‹é›¨ï¼Œå¸¸è¦‹æ²™å¡µæš´
- æ£®æ—ï¼šå¸¸èµ·éœ§ï¼Œå¤šé›¨
- å±±è„ˆï¼šå¤šé›ªï¼Œæº«åº¦ä½

### 5. æ¥µç«¯å¤©æ°£äº‹ä»¶
ç½•è¦‹ä½†å½±éŸ¿å¤§çš„ç‰¹æ®Šå¤©æ°£ï¼š
```json
{
  "weight": 0.01,
  "action": {
    "type": "set_map_property",
    "map": "beginMap",
    "property": "å¤©æ°£",
    "value": "æš´é¢¨é›¨"
  }
}
```

## æ•…éšœæ’é™¤

### å•é¡Œï¼šå¤©æ°£æ²’æœ‰è®ŠåŒ–
1. æª¢æŸ¥äº‹ä»¶æª”æ¡ˆæ˜¯å¦æ­£ç¢ºè¼‰å…¥
2. ç¢ºèª `schedule` è¨­å®šæ­£ç¢ºï¼ˆCrontab æ ¼å¼ï¼‰
3. æª¢æŸ¥ `cooldown` æ˜¯å¦å¤ªé•·

### å•é¡Œï¼šæ©Ÿç‡åˆ†å¸ƒä¸æ­£ç¢º
1. é©—è­‰æ‰€æœ‰ `weight` å€¼éƒ½æ˜¯æ­£æ•¸
2. æª¢æŸ¥æ˜¯å¦æœ‰ JSON æ ¼å¼éŒ¯èª¤
3. å¢åŠ æ¸¬è©¦æ¬¡æ•¸ï¼ˆæ©Ÿç‡éœ€è¦å¤§é‡æ¨£æœ¬æ‰æº–ç¢ºï¼‰

### å•é¡Œï¼šåœ°åœ–å±¬æ€§æ²’æœ‰æ›´æ–°
1. ç¢ºèªåœ°åœ–åç¨±æ­£ç¢º
2. æª¢æŸ¥ `set_map_property` å‹•ä½œæ˜¯å¦è¢«åŸ·è¡Œ
3. æŸ¥çœ‹éŠæˆ²æ—¥èªŒä¸­çš„éŒ¯èª¤è¨Šæ¯

## ç›¸é—œæª”æ¡ˆ

### æ ¸å¿ƒç¨‹å¼ç¢¼
- `src/event.rs` - äº‹ä»¶çµæ§‹å®šç¾©
- `src/event_executor.rs` - äº‹ä»¶åŸ·è¡Œé‚è¼¯
- `src/map.rs` - åœ°åœ–å±¬æ€§ç³»çµ±

### ç¯„ä¾‹äº‹ä»¶
- `worlds/beginWorld/events/weather_event.json` - åŸºæœ¬å¤©æ°£ç³»çµ±
- `worlds/beginWorld/events/environment_events.json` - å¤©æ°£èˆ‡æº«åº¦ç³»çµ±

### æ–‡æª”
- `Docs/weather_event_example.md` - å¤©æ°£äº‹ä»¶ç¯„ä¾‹èªªæ˜
- `Docs/probability_event_system.md` - æœ¬æ–‡æª”

## ç¸½çµ

æ©Ÿç‡æ¬Šé‡äº‹ä»¶ç³»çµ±ç‚ºéŠæˆ²å¢åŠ äº†è±å¯Œçš„å‹•æ…‹æ€§ï¼Œä½¿å¾—ç’°å¢ƒèƒ½å¤ æ›´åŠ çœŸå¯¦å’Œå¤šè®Šã€‚é€éç°¡å–®çš„ JSON é…ç½®ï¼Œå°±èƒ½å‰µå»ºè¤‡é›œçš„éš¨æ©Ÿäº‹ä»¶ç³»çµ±ï¼Œç„¡éœ€ä¿®æ”¹ç¨‹å¼ç¢¼ã€‚

ä¸»è¦å„ªå‹¢ï¼š
âœ… éˆæ´»çš„æ©Ÿç‡æ§åˆ¶
âœ… æ”¯æ´è¤‡é›œçš„å‹•ä½œçµ„åˆ
âœ… æ˜“æ–¼é…ç½®å’Œèª¿æ•´
âœ… å¯æ“´å±•æ€§å¼·
âœ… é©ç”¨æ–¼å„ç¨®éŠæˆ²æ©Ÿåˆ¶ï¼ˆå¤©æ°£ã€éš¨æ©Ÿäº‹ä»¶ã€æˆ°åˆ©å“æ‰è½ç­‰ï¼‰
